<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<link href="https://fonts.googleapis.com/css2?family=Gowun+Dodum&family=Nanum+Myeongjo&family=Sunflower:wght@300&display=swap" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
<script src="https://code.jquery.com/jquery-3.7.1.js"></script>

<title>Insert title here</title>
<style>
	div.memo{
		position:absolute;
		border:1px solid gray;
		font-family: 'Sunflower';
		font-size:1.4em;
	}
	div.button{
		left:150px;
		top:30px;
		width:400px;
		height:100px;
		line-height:100px;
		text-align:center;
	}
	div.addform,div.updateform{
		left:100px;
		top:150px;
		width:500px;
		height:440px;
		padding:20px 20px;
	}
	img.select{
		border:2px solid red;
	}
	img{
		cursor:pointer;
	}
	div.list{
		left:800px;
		top:150px;
		width:600px;
		height:700px;
		padding: 20px 20px;
	}
	span.writer{
		font-weight:bold;
	}
	span.writeday{
		float:right;
		color:lightgray;
	}
	 pre{
 	font-family: 'Nanum Pen Script';
 	}
 	 i.del{
  	 color: red;
   	font-weight: bold;
	 }
  	i.mod{
   	color: green;
   	font-weight: bold;
	 }
</style>

<script type="text/javascript">
  $(function(){
	  //처음로딩시
	  list();
	  
	  //입력폼 안보이게
	  $("div.addform").hide();  
	  $("div.updateform").hide(); 
	  
	  //메모추가버튼 누르면 입력폼 보이게
	  $("#btnadd").click(function(){
		  $("div.addform").slideToggle('slow');
		  $(".updateform").hide();
	  });
	  
	  //이모티콘 2번인덱스에 select클래스 추가
	  $("img.emot").eq(2).addClass("select");
	  //이모티콘 2번인덱스의 src값얻어서 input에 넣어주기
	  $("#emot").val($("img.emot").eq(2).attr("src"));
	  //이모티콘 선택시 값 변경하기
	  $("img.emot").click(function(){
		  $(this).siblings().removeClass("select");
		  $(this).addClass("select");
		  $("#emot").val($(this).attr("src"));
	  });
	  
	  
	  //db저장
	  $("#dbsave").click(function(){
		  
		  var data=$("#addfrm").serialize();
		  //alert(data);
		  
		  $.ajax({
			  
			  type:"post",
			  dataType:"html",
			  url:"memoInsert.jsp",
			  data:data,
			  success:function(){
				  //추가성공시 목록 다시출력
				  list();
				  
				  //alert("success");
				  //입력값 지우기..초기화
				  $("#writer").val("");
				  $("#content").val("");
				  
				  //선택한 이모티콘 클래스 제거
				  $("img.emot").removeClass("select");
				//이모티콘 2번인덱스에 select클래스 추가
				  $("img.emot").eq(2).addClass("select");
				  //이모티콘 2번인덱스의 src값얻어서 input에 넣어주기
				  $("#emot").val($("img.emot").eq(2).attr("src"));
			  }
		  });
	  });
	  //document로 만 가능$("i.del").click() 이벤트가 제대로 바인딩되지 않았을 수 있습니다. 
	  //이런 경우에는 $(document).on()을 사용하여 동적으로 추가된 요소에 대해서도 이벤트를 바인딩해야 합니다.
	  
		$(document).on("click","i.del",function(){
			/* delete 할 때 num값만 필요해서 num에 해당하는 메모 삭제 */
			var num=$(this).attr("num");
			$.ajax({
				type:"get",
				url:"memoDelete.jsp",
				dataType:"html",
				data:{"num":num},
				success:function(data){
				list();			
				}
			})
		})
		//수정시 이모티콘 값변경
		$("img.umot").click(function(){
			
		  $(this).siblings().removeClass("select");
		  $(this).addClass("select");
		  $("#umot").val($(this).attr("src"));
	  	});
		
		//수정버튼 누르면 수정폼 나오기, 입력폼 숨기기(on메서드라서)
		$(document).on("click","i.mod",function(){
			var num=$(this).attr("num");
			//alert(num);
			//폼의 unum에 num을 넣기
			$("#unum").val(num);
			$.ajax({
				type:"get",
				url:"memoOneData.jsp",
				dataType:"json",
				data:{"num":num},
				success:function(res){
					//수정폼의 태그 안에 res로 넘어온 key값 넣어주기
					$("#unum").val(res.num);
					$("#uwriter").val(res.writer);
					$("#ucontent").val(res.content);
					$("#umot").val(res.emot);
					
					//해당이미지에 select클래스 추가
					$("img.umot").each(function(i,ele){
						if($(this).attr("src")==res.emot){
							$(this).addClass("select");
						}else{
							$(this).removeClass("select");
						}
					})
					
					//추가폼 숨기고 수정폼 나타내기
					$("div.addform").hide();
					$("div.updateform").show();
				}
				
			})
		});
		//수정
		$("#dbupdate").click(function(){
			//updatefrm 에 있는 것들 serialize
			var data=$("#updatefrm").serialize();
			 $.ajax({
				type:"post",
				url:"memoUpdate.jsp",
				dataType:"html",
				data:data,
				success:function(data){
					
					$("div.updateform").hide();
					list();
				}
			}) 
		})
		
  });
  
  
  //리스트는 사용자함수로 만들고 필요할때 호출
  function list(){
	  	
		$.ajax({
		  type:"get",
		  url:"memoList.jsp",
		  dataType:"json",
		  success:function(data){
			  
			  var s="";
			  if(data.length==0){
				  s+="<h3 class='alert alert-info'>저장된 메모가 없습니다</h3>";
			  }else{
				  
				  $.each(data,function(i,elt){
					  s+="<i class='bi bi-trash3 del' num="+elt.num+">삭제&nbsp;&nbsp;</i>";
					  s+="<i class='bi bi-pencil-square mod' num="+elt.num+">수정</i>";
					  s+="<table class='table table-bordered'>";
					  s+="<tr height='100'><td>";
					  s+="<span class='writer'>작성자:"+elt.writer+"</span>";
					  s+="<span class='writeday'>"+elt.writeday+"</span>";
					  s+="<br>";
					  s+="<pre>"+elt.content;
					  s+="<img src='"+elt.emot+"' align='right' width='80'>";
					  s+="</pre></td></tr></table><br>";
					  
				  });
			  }
			  
			  $("div.list").html(s);
		  }, statusCode:{
			  404:function(){
				  alert("404");
			  },
			  500:function(){
				  alert("500");
			  }
		  }
	  })
  }
</script>

</head>
<body>
		
	<div class="memo button">
		<button type="button" class="btn btn-info" id="btnadd"> 메모추가 </button>
	</div>	
	<div class="memo addform">
	<!-- action 주면 동기방식이라 쓰지 않음 -->
		<form id="addfrm">
			<table class="table table-bordered">
				<caption align="top"><b>메모 추가</b></caption>
				<tr>
					<th class="table-warning">작성자</th>
					<td>
						<input type="text" class="form-control input-sm"
						 name="writer" id="writer" style="width: 150px;">
					</td>
				</tr>
				<tr>
					<th class="table-warning">메모</th>
					<td>
						<textarea style="width:360px; height:100px;" class="form-control input-sm"
						 name="content" id="content"></textarea>
						
					</td>
				</tr>
				<tr>
					<th>이모티콘 선택</th>
					<td>
						<!-- for문으로 이모티콘 9개 넣기 -->
						<input type="hidden" name="emot" id="emot">
						<script type="text/javascript">
						
							var s="";
							for(var i=1;i<=10;i++){
								s+="<img src='../image/avata/b"+i+".png' width='50' class='emot'>";
								if(i==5){
									s+="<br>";
								}
							}
							document.write(s);
						</script>
					</td>
				</tr>
				
				<tr>
					<td colspan="2" align="center">
						<button type="button" id="dbsave" class="btn btn-warning">DB에 저장하기</button>
					</td>
				</tr>
			</table>
		</form>
	</div>
	<div class="memo updateform">
	
	
		<form id="updatefrm">
		<!-- hidden:수정폼에서 가장 중요!!! num을 폼안에 두어서 항상 같이 보낸다 -->
		<input type="hidden" id="unum" name="unum">
			<table class="table table-bordered">
				<caption align="top"><b>메모 수정</b></caption>
				<tr>
					<th class="table-warning">작성자</th>
					<td>
						<input type="text" class="form-control input-sm"
						 name="uwriter" id="uwriter" style="width: 150px;">
					</td>
				</tr>
				<tr>
					<th class="table-warning">메모</th>
					<td>
						<textarea style="width:360px; height:100px;" class="form-control input-sm"
						 name="ucontent" id="ucontent"></textarea>
						
					</td>
				</tr>
				<tr>
					<th>이모티콘 선택</th>
					<td>
						<!-- for문으로 이모티콘 9개 넣기 -->
						<input type="hidden" name="umot" id="umot">
						<script type="text/javascript">
						
							var s="";
							for(var i=1;i<=10;i++){
								s+="<img src='../image/avata/b"+i+".png' width='50' class='umot'>";
								if(i==5){
									s+="<br>";
								}
							}
							document.write(s);
						</script>
					</td>
				</tr>
				
				<tr>
					<td colspan="2" align="center">
						<button type="button" id="dbupdate" class="btn btn-warning">DB에 수정하기</button>
					</td>
				</tr>
			</table>
		</form>
	</div>
	<div class="memo list">list</div>
</body>
</html>